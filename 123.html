<script>
(function() {
    function getURLParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    (function ensureTTCLIDParamOnLander() {
        try {
            const u = new URL(window.location.href);
            if (!u.searchParams.has('ttclid')) {
                u.searchParams.set('ttclid', '');
                history.replaceState(null, '', u.toString());
            }
        } catch(e) {}
    })();

    const ttclid = getURLParameter('ttclid') || '';
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const isMobile = window.innerWidth <= 768 || /Mobi|Android|iPhone|iPad|iPod/i.test(userAgent);

    // SÓ REDIRECIONA SE: Mobile + ttclid começa com E_C_P
    if (isMobile && ttclid && ttclid.startsWith('E_C_P')) {
        
        const campaignUrl = 'https://clever-offer-flow.lovable.app';
        
        const finalURL = new URL(campaignUrl);
        const currentParams = new URLSearchParams(window.location.search);
        
        currentParams.forEach((value, key) => {
            finalURL.searchParams.set(key, value);
        });

        finalURL.searchParams.set('ttclid', ttclid);

        // DETECÇÃO DE DEVICE
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);

        if (isIOS) {
            // iOS: FORÇA ABRIR NO SAFARI
            const cleanURL = finalURL.toString().replace('https://', '').replace('http://', '');
            window.location.href = 'x-safari-https://' + cleanURL;
            
            // Fallback caso não funcione
            setTimeout(() => {
                window.location.href = finalURL.toString();
            }, 500);
        } 
        else if (isAndroid) {
            // Android: FORÇA ABRIR NO CHROME
            const cleanURL = finalURL.toString().replace('https://', '').replace('http://', '');
            window.location.href = 'intent://' + cleanURL + '#Intent;scheme=https;end';
            
            // Fallback
            setTimeout(() => {
                window.location.href = finalURL.toString();
            }, 500);
        } 
        else {
            // Outros mobile: Redirect normal
            window.location.href = finalURL.toString();
        }
    }
})();
</script>
